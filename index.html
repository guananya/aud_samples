<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Dataset Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
        }
        
        .header h1 {
            margin-bottom: 15px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .controls input, .controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .tag-filters {
            background: #34495e;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .tag-filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .tag-filters h3 {
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        
        .tag-search {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 200px;
        }
        
        .tag-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #2c3e50;
            border-radius: 4px;
        }
        
        .tag-filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #34495e;
            border-radius: 4px;
            font-size: 12px;
            color: white;
        }
        
        .tag-filter-item input[type="checkbox"] {
            cursor: pointer;
        }
        
        .tag-filter-item label {
            cursor: pointer;
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        
        .tag-name {
            flex: 1;
        }
        
        .tag-threshold-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .tag-threshold {
            width: 60px;
            padding: 3px 6px;
            border: 1px solid #95a5a6;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .stats {
            background: #ecf0f1;
            padding: 15px 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .stat {
            font-size: 14px;
        }
        
        .stat strong {
            color: #2c3e50;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #ecf0f1;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid #bdc3c7;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination span {
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: calc(100vh - 400px);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            position: sticky;
            top: 0;
            background: #34495e;
            color: white;
            z-index: 10;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        
        th:hover {
            background: #2c3e50;
        }
        
        th.sortable::after {
            content: ' ⇅';
            opacity: 0.3;
        }
        
        th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
        }
        
        th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .text-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .text-cell:hover {
            white-space: normal;
            overflow: visible;
        }
        
        .tags-cell {
            max-width: 400px;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .tag-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
            font-size: 11px;
        }
        
        audio {
            width: 250px;
            height: 32px;
        }
        
        .num-cell {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .toggle-tags {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .toggle-tags:hover {
            background: #2980b9;
        }
        
        .tag-filters.collapsed .tag-filter-grid {
            display: none;
        }
        
        .clear-filters {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .clear-filters:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Audio Dataset Viewer</h1>
            <div class="controls">
                <input type="text" id="searchBox" placeholder="Search text, transcript, description...">
                <select id="filterLanguage">
                    <option value="">All Languages</option>
                </select>
                <select id="filterDuration">
                    <option value="">All Durations</option>
                    <option value="0-5">0-5s</option>
                    <option value="5-10">5-10s</option>
                    <option value="10-20">10-20s</option>
                    <option value="20+">20s+</option>
                </select>
            </div>
            
            <div class="tag-filters" id="tagFilters">
                <div class="tag-filters-header">
                    <h3>Tag Filters (select tags and set minimum thresholds)</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" class="tag-search" id="tagSearch" placeholder="Search tags...">
                        <button class="clear-filters" onclick="clearAllFilters()">Clear All</button>
                        <button class="toggle-tags" onclick="toggleTagFilters()">Hide Filters</button>
                    </div>
                </div>
                <div class="tag-filter-grid" id="tagFilterGrid">
                    <div class="loading">Loading tags...</div>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat">Total: <strong id="totalCount">0</strong></div>
            <div class="stat">Filtered: <strong id="filteredCount">0</strong></div>
            <div class="stat">Avg Duration: <strong id="avgDuration">0</strong>s</div>
            <div class="stat">Avg CPS: <strong id="avgCPS">0</strong></div>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="id">ID</th>
                        <th>Audio</th>
                        <th class="sortable" data-column="duration">Duration</th>
                        <th class="sortable" data-column="CPS">CPS</th>
                        <th class="sortable" data-column="pq">PQ</th>
                        <th class="sortable" data-column="snr">SNR</th>
                        <th class="sortable" data-column="language">Language</th>
                        <th>Text</th>
                        <th>Transcript</th>
                        <th>Top Tags (>0.1)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="10" class="loading">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="pagination">
            <button id="firstPage" onclick="goToPage(0)">First</button>
            <button id="prevPage" onclick="goToPage(currentPage - 1)">Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button id="nextPage" onclick="goToPage(currentPage + 1)">Next</button>
            <button id="lastPage" onclick="goToPage(totalPages - 1)">Last</button>
            <select id="pageSize" onchange="changePageSize()">
                <option value="50">50 per page</option>
                <option value="100" selected>100 per page</option>
                <option value="200">200 per page</option>
                <option value="500">500 per page</option>
            </select>
        </div>
    </div>
    
    <script type="module">
        // Dataset configuration
        const DATASET_NAME = 'ananyahume/processed_audio_samples';
        
        let allData = [];
        let filteredData = [];
        let allTags = [];
        let activeTagFilters = {}; // {tagName: threshold}
        let sortColumn = 'id';
        let sortDirection = 'asc';
        let currentPage = 0;
        let pageSize = 100;
        let totalPages = 1;
        
        // Load dataset from Hugging Face
        async function loadDataset() {
            try {
                const response = await fetch(`https://datasets-server.huggingface.co/rows?dataset=${DATASET_NAME}&config=default&split=train&offset=0&length=100000`);
                const data = await response.json();
                
                console.log('Dataset loaded:', data);
                
                // Process rows
                allData = data.rows.map((row, idx) => {
                    const item = row.row;
                    
                    // Extract SNR from brouhaha_mean
                    let snr = 0;
                    if (item['brouhaha_mean.json']) {
                        snr = item['brouhaha_mean.json'].mean_snr || 0;
                    }
                    
                    // Extract tags
                    const tags = {};
                    const tagSet = new Set();
                    Object.keys(item).forEach(key => {
                        if (key.startsWith('tag_')) {
                            const tagName = key.substring(4);
                            tags[tagName] = item[key];
                            tagSet.add(tagName);
                        }
                    });
                    
                    // Collect all unique tags
                    tagSet.forEach(tag => allTags.push(tag));
                    
                    return {
                        id: idx,
                        audio: item.audio,
                        duration: item['duration.json'] || 0,
                        txt: item.txt || '',
                        transcript: item.transcript || '',
                        description: item.description || '',
                        pq: item['pq.json'] || 0,
                        utmos: item['utmos.json'] || 0,
                        snr: snr,
                        language: item['language_whisper.txt'] || '',
                        accent: item.accent_txt || '',
                        CPS: item.CPS || 0,
                        tags: tags
                    };
                });
                
                // Get unique tags
                allTags = [...new Set(allTags)].sort();
                
                console.log(`Loaded ${allData.length} samples with ${allTags.length} unique tags`);
                
                // Populate language filter
                const languages = [...new Set(allData.map(d => d.language))].filter(Boolean).sort();
                const langSelect = document.getElementById('filterLanguage');
                languages.forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang;
                    option.textContent = lang;
                    langSelect.appendChild(option);
                });
                
                // Build tag filters UI
                buildTagFilters();
                
                filteredData = [...allData];
                renderTable();
                updateStats();
                
            } catch (error) {
                console.error('Error loading dataset:', error);
                document.getElementById('tableBody').innerHTML = 
                    `<tr><td colspan="10" class="loading" style="color: red;">Error loading dataset: ${error.message}</td></tr>`;
            }
        }
        
        function buildTagFilters() {
            const grid = document.getElementById('tagFilterGrid');
            grid.innerHTML = allTags.map(tag => `
                <div class="tag-filter-item">
                    <input type="checkbox" id="tag_${tag}" value="${tag}" onchange="window.toggleTagFilter('${tag}', this.checked)">
                    <label for="tag_${tag}">
                        <span class="tag-name">${tag}</span>
                        <div class="tag-threshold-container">
                            <span style="font-size: 10px;">≥</span>
                            <input type="number" class="tag-threshold" id="threshold_${tag}" 
                                   value="0.1" min="0" max="1" step="0.01" 
                                   onchange="window.updateTagThreshold('${tag}', this.value)">
                        </div>
                    </label>
                </div>
            `).join('');
        }
        
        // Make functions globally accessible
        window.toggleTagFilter = function(tagName, isChecked) {
            if (isChecked) {
                const threshold = parseFloat(document.getElementById(`threshold_${tagName}`).value);
                activeTagFilters[tagName] = threshold;
            } else {
                delete activeTagFilters[tagName];
            }
            filterData();
        };
        
        window.updateTagThreshold = function(tagName, value) {
            if (activeTagFilters[tagName] !== undefined) {
                activeTagFilters[tagName] = parseFloat(value);
                filterData();
            }
        };
        
        window.clearAllFilters = function() {
            activeTagFilters = {};
            document.querySelectorAll('.tag-filter-item input[type="checkbox"]').forEach(cb => cb.checked = false);
            filterData();
        };
        
        window.toggleTagFilters = function() {
            const filters = document.getElementById('tagFilters');
            const btn = event.target;
            filters.classList.toggle('collapsed');
            btn.textContent = filters.classList.contains('collapsed') ? 'Show Filters' : 'Hide Filters';
        };
        
        // Search and filter
        document.getElementById('searchBox').addEventListener('input', filterData);
        document.getElementById('filterLanguage').addEventListener('change', filterData);
        document.getElementById('filterDuration').addEventListener('change', filterData);
        
        // Tag search
        document.getElementById('tagSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.tag-filter-item').forEach(item => {
                const tagName = item.querySelector('.tag-name').textContent.toLowerCase();
                item.style.display = tagName.includes(searchTerm) ? 'flex' : 'none';
            });
        });
        
        function filterData() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const langFilter = document.getElementById('filterLanguage').value;
            const durFilter = document.getElementById('filterDuration').value;
            
            filteredData = allData.filter(item => {
                // Search filter
                const searchMatch = !searchTerm || 
                    item.txt.toLowerCase().includes(searchTerm) ||
                    item.transcript.toLowerCase().includes(searchTerm) ||
                    item.description.toLowerCase().includes(searchTerm);
                
                // Language filter
                const langMatch = !langFilter || item.language === langFilter;
                
                // Duration filter
                let durMatch = true;
                if (durFilter) {
                    const dur = item.duration;
                    if (durFilter === '0-5') durMatch = dur <= 5;
                    else if (durFilter === '5-10') durMatch = dur > 5 && dur <= 10;
                    else if (durFilter === '10-20') durMatch = dur > 10 && dur <= 20;
                    else if (durFilter === '20+') durMatch = dur > 20;
                }
                
                // Tag filters (AND logic - all selected tags must meet threshold)
                let tagMatch = true;
                for (const [tagName, threshold] of Object.entries(activeTagFilters)) {
                    if (!item.tags[tagName] || item.tags[tagName] < threshold) {
                        tagMatch = false;
                        break;
                    }
                }
                
                return searchMatch && langMatch && durMatch && tagMatch;
            });
            
            currentPage = 0;
            renderTable();
            updateStats();
        }
        
        // Sorting
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;
                
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                
                // Update UI
                document.querySelectorAll('th.sortable').forEach(t => {
                    t.classList.remove('sort-asc', 'sort-desc');
                });
                th.classList.add(`sort-${sortDirection}`);
                
                // Sort data
                filteredData.sort((a, b) => {
                    let aVal = a[column];
                    let bVal = b[column];
                    
                    if (typeof aVal === 'string') {
                        return sortDirection === 'asc' 
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    } else {
                        return sortDirection === 'asc'
                            ? aVal - bVal
                            : bVal - aVal;
                    }
                });
                
                renderTable();
            });
        });
        
        // Pagination
        window.goToPage = function(page) {
            if (page >= 0 && page < totalPages) {
                currentPage = page;
                renderTable();
            }
        };
        
        window.changePageSize = function() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 0;
            renderTable();
        };
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="loading">No results found</td></tr>';
                return;
            }
            
            // Calculate pagination
            totalPages = Math.ceil(filteredData.length / pageSize);
            const startIdx = currentPage * pageSize;
            const endIdx = Math.min(startIdx + pageSize, filteredData.length);
            const pageData = filteredData.slice(startIdx, endIdx);
            
            tbody.innerHTML = pageData.map(item => {
                // Get top tags above 0.1
                const topTags = Object.entries(item.tags)
                    .filter(([_, value]) => value > 0.1)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([tag, value]) => `<span class="tag-badge">${tag}: ${value.toFixed(2)}</span>`)
                    .join('');
                
                // Handle audio path
                const audioPath = item.audio?.path || item.audio || '';
                
                return `
                    <tr>
                        <td class="num-cell">${item.id}</td>
                        <td><audio controls preload="none" src="${audioPath}"></audio></td>
                        <td class="num-cell">${item.duration.toFixed(2)}</td>
                        <td class="num-cell">${item.CPS.toFixed(1)}</td>
                        <td class="num-cell">${item.pq.toFixed(2)}</td>
                        <td class="num-cell">${item.snr.toFixed(1)}</td>
                        <td>${item.language}</td>
                        <td class="text-cell" title="${item.txt}">${item.txt}</td>
                        <td class="text-cell" title="${item.transcript}">${item.transcript}</td>
                        <td class="tags-cell">${topTags || '<span style="color: #999;">No high tags</span>'}</td>
                    </tr>
                `;
            }).join('');
            
            // Update pagination UI
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${totalPages}`;
            document.getElementById('firstPage').disabled = currentPage === 0;
            document.getElementById('prevPage').disabled = currentPage === 0;
            document.getElementById('nextPage').disabled = currentPage >= totalPages - 1;
            document.getElementById('lastPage').disabled = currentPage >= totalPages - 1;
        }
        
        function updateStats() {
            document.getElementById('totalCount').textContent = allData.length.toLocaleString();
            document.getElementById('filteredCount').textContent = filteredData.length.toLocaleString();
            
            if (filteredData.length > 0) {
                const avgDur = filteredData.reduce((sum, item) => sum + item.duration, 0) / filteredData.length;
                const avgCPS = filteredData.reduce((sum, item) => sum + item.CPS, 0) / filteredData.length;
                
                document.getElementById('avgDuration').textContent = avgDur.toFixed(2);
                document.getElementById('avgCPS').textContent = avgCPS.toFixed(1);
            }
        }
        
        // Load dataset on page load
        loadDataset();
    </script>
</body>
</html>
